import{u as G,r as m,j as l,m as q,a as e,F as te,L as i,q as w,C as D,Y as Ue,Z as Me,b as B,d as re,f as H,p as U,P as X,E as Re,J as Le,_ as ne,$ as Ne,S as pe,N as ie,A as z,I as _e,g as se,a0 as $e,i as Se,a1 as Ve,a2 as Ce,a3 as he,a4 as be,a5 as xe,H as ce,a6 as Ee,s as Y,t as fe,a7 as ge,a8 as Fe,a9 as de,aa as ve,ab as Te,ac as Ae,O as Ye,Q as He,ad as me,o as je,ae as We,e as K,af as Be,y as Xe,z as Ze,ag as qe,ah as ze,w as Qe,ai as Ke,aj as Je,x as et}from"./index-646d6ab8.js";import{A as tt,g as at}from"./audioRecorder-59577a50.js";import{g as st,i as nt,M as it,L as rt,C as lt,D as Pe,T as ot,a as ct,b as dt,c as mt,A as ut}from"./Maps-fa3ff6ba.js";const we=t=>{if(t)return/<!SENT-LOCATION-X=(-?\d*\.?\d*)Y=(-?\d*\.?\d*)!>/.test(t)},Ie=t=>{if(t)return t==="<!CALL-NO-ANSWER!>"},St=t=>{if(t)return/<!AUDIO-MESSAGE-IMAGE="(.*)"-AUDIO="(.*)"-DURATION="(.*)"!>/.test(t)},ht=t=>{if(t.length===0)return!0;if(t)return!/^<!.*!>$/.test(t)},Et=({onEnd:t,close:r})=>{const A=G(B),[P,N]=m.useState(!1),[p,u]=m.useState(0),[a,b]=m.useState(null),S=m.useRef(null);if(!A.EnableVoiceMessages)return null;m.useEffect(()=>{if(!P)return;let o=setInterval(()=>{u(E=>E+1)},1e3);return()=>clearInterval(o)},[P]),m.useEffect(()=>(S.current=new tt,()=>{S.current&&S.current.stop()}),[]);const y=o=>{let E=Math.floor(o/60),f=o%60;return`${E}:${f<10?"0":""}${f}`},s=async o=>{const E=await at(new Blob(o),25,7,324,55,3);b(E)};return l(q.div,{initial:{opacity:0,y:20},animate:{opacity:1,y:0},exit:{opacity:0,y:0},transition:{duration:.2,ease:"easeInOut"},className:"audioMessage-container",children:[e("div",{className:"close",onClick:r}),l("div",{className:"audioMessage-wrapper",children:[l("div",{className:"duration",children:[P&&e("div",{className:"dot"}),y(p)]}),e("div",{className:"content",children:P?e(te,{children:a!=null&&a.base64?e("img",{src:a==null?void 0:a.base64}):i("APPS.MESSAGES.LOADING")}):i("APPS.MESSAGES.START_RECORDING")}),e("div",{className:"button","data-recording":P,onClick:()=>{var E;if(!((E=navigator.mediaDevices)!=null&&E.getUserMedia)||!(S!=null&&S.current))return w("error","No media devices found!");let o=S.current;P?o.stop().then(f=>{if(!f){u(0),N(c=>!c),D.PopUp.set({title:i("APPS.MESSAGES.EMPTY_RECORDING.TITLE"),description:i("APPS.MESSAGES.EMPTY_RECORDING.DESCRIPTION"),buttons:[{title:i("APPS.MESSAGES.EMPTY_RECORDING.OK")}]});return}t(f),N(c=>!c)}):(o.start(100,s),N(f=>!f))},children:P?e(Ue,{}):e(Me,{})})]})]})},ft=({paymentAmount:t,setPaymentAmount:r,close:A})=>{const{User:P}=m.useContext(ae),N=G(B),[p]=P,[u,a]=m.useState(0),[b,S]=m.useState(4);let y={0:3,11:2.75,14:2.2};return m.useEffect(()=>{u===0&&S(y[0]);let s=0;for(let o=0;o<Object.keys(y).length;o++)u>=parseInt(Object.keys(y)[o])&&(s=y[Object.keys(y)[o]]);S(s)},[u]),m.useEffect(()=>{r(u)},[u]),l(q.div,{initial:{opacity:0,y:20},animate:{opacity:1,y:0},exit:{opacity:0,y:0},transition:{duration:.2,ease:"easeInOut"},className:"payment-container",children:[e("div",{className:"close",onClick:A}),l("div",{className:"payment-wrapper",children:[e("div",{className:"button",onClick:()=>t>0&&a(s=>s-1),children:"-"}),e("div",{className:"amount",children:e(re,{type:"number",value:t,style:{fontSize:`${b}rem`},onChange:s=>{if(s.target.value.match(/^[0-9]+$/)&&parseFloat(s.target.value)>0&&parseFloat(s.target.value)<(N.MaxTransferAmount??Number.MAX_SAFE_INTEGER))a(parseFloat(s.target.value));else return s.preventDefault()}})}),e("div",{className:"button",onClick:()=>a(s=>s+1),children:"+"})]}),l("div",{className:"payment-buttons",children:[e("div",{className:"button",onClick:()=>gt(t,p.number),children:i("APPS.MESSAGES.PAY.REQUEST")}),e("div",{className:"button",onClick:()=>Oe(t,{id:p.id,name:p.name,number:p.number}),children:i("APPS.MESSAGES.PAY.SEND")})]})]})},Oe=(t,r)=>{var A;if(B.value.EnableMessagePay&&!(!t&&t<=0)){if(t>(((A=B.value)==null?void 0:A.MaxTransferAmount)??Number.MAX_SAFE_INTEGER))return w("error","Amount is too high");D.PopUp.set({title:i("APPS.MESSAGES.PAY.SEND_TITLE").format({amount:B.value.CurrencyFormat.replace("%s",t.toString())}),description:i("APPS.MESSAGES.PAY.SEND_DESCRIPTION").format({amount:B.value.CurrencyFormat.replace("%s",t.toString()),name:r.name??H(r.number)}),buttons:[{title:i("APPS.MESSAGES.PAY.SEND_BUTTON_CANCEL")},{title:i("APPS.MESSAGES.PAY.SEND_BUTTON_SEND"),cb:()=>{U("Wallet",{action:"sendPayment",number:r.number,amount:t},{success:!0}).then(P=>{var N,p;if(P.success){let u={id:r.id,sender:(p=(N=X)==null?void 0:N.PhoneNumber)==null?void 0:p.value,content:`<!SENT-PAYMENT-${t}!>`,attachments:[],timestamp:Date.now()};O.set([...O.value,u])}else{w("error","Failed to send payment "+JSON.stringify(P)),setTimeout(()=>{D.PopUp.set({title:i(`APPS.WALLET.${P.reason}.TITLE`),description:i(`APPS.WALLET.${P.reason}.DESCRIPTION`),buttons:[{title:i("APPS.WALLET.OK")}]})},500);return}})}}]})}},gt=(t,r)=>{var P,N;if(!B.value.EnableMessagePay||!t&&t<=0)return;let A={sender:(N=(P=X)==null?void 0:P.PhoneNumber)==null?void 0:N.value,content:`<!REQUESTED-PAYMENT-${t}!>`,attachments:[],timestamp:Date.now()};U("Messages",{action:"sendMessage",number:r,content:A.content,attachments:[]},{messageId:Math.floor(Math.random()*1e3).toString()}).then(p=>{if(!p)return O.set([...O.value,{...A,delivered:!1}]);O.set([...O.value,{...A,id:p.messageId}])})},Ge={Messagelist:[{id:"1",number:"4802940940",name:"Loaf Scripts",unread:!0,lastMessage:"Sure Thing!",messages:[{sender:"4802940940",content:"Sure Thing!",timestamp:Date.now()-1e3*60*60*2},{sender:"1234567890",content:"Ready to release more products?",timestamp:Date.now()-1e3*60*60*2-1e3*60*5},{sender:"4802940940",content:"Hey!",timestamp:Date.now()-1e3*60*60*2-1e3*60*10}],timestamp:Date.now()-1e3*60*60*2},{id:"2",name:"Office Chat",unread:!0,lastMessage:"is the meeting at 8pm?",timestamp:Date.now()-1e3*60*60*4,isGroup:!0,members:[{number:"4802940940",name:"Loaf Scripts",isOwner:!1},{number:"1566444151",name:"Peter",isOwner:!1},{number:"2051440412",name:"Peter",isOwner:!1},{number:"2051440412",isOwner:!1}],messages:[{sender:"4802940940",content:"is the meeting at 8pm?",timestamp:Date.now()-1e3*60*60*4},{sender:"1566444151",content:"please confirm the time",timestamp:Date.now()-1e3*60*60*4-1e3*60*5},{sender:"2051440412",content:"Hey everyone, please make sure to be on time for the meeting",timestamp:Date.now()-1e3*60*60*4-1e3*60*10}]},{id:"3",number:"4802940963",unread:!1,lastMessage:"yeah i dont know whats going on, it was super weird. i think i might have to go to the doctor",timestamp:Date.now()-1e3*60*60*2*24,messages:[{sender:"4802940940",content:"yeah i dont know whats going on, it was super weird. i think i might have to go to the doctor",timestamp:Date.now()-1e3*60*60*2*24},{sender:"1234567890",content:"i hope you feel better soon",timestamp:Date.now()-1e3*60*60*2*24-1e3*60*5},{sender:"4802940940",content:"still sick :(",timestamp:Date.now()-1e3*60*60*2*24-1e3*60*10}]},{id:"4",number:"4802940942",unread:!0,lastMessage:"see you!",timestamp:Date.now()-1e3*60*60*2*24*2,messages:[{sender:"4802940942",content:"<!SENT-LOCATION-X=400.2Y=-1550.3!>",timestamp:Date.now()-1e3*60*60*2*24},{sender:"4802940942",content:`see you!

heres the location`,timestamp:Date.now()-1e3*60*60*2*24*2},{sender:"1234567890",content:"ofcourse, i will be there",timestamp:Date.now()-1e3*60*60*2*24*2-1e3*60*3},{sender:"4802940942",content:"hey buddy, still on for tomorrow?",timestamp:Date.now()-1e3*60*60*2*24*2-1e3*60*3}]}]};function vt({location:t}){const r=G(ut),[A,P]=m.useState("losSantos"),N=Pe.mapTypes[A],p=st(A);return m.useEffect(()=>{P(nt({x:t[0],y:t[1]})?"losSantos":"cayoPerico")},[t]),m.useEffect(()=>{setTimeout(()=>{const u=document.querySelector(".leaflet-control-attribution.leaflet-control a");u&&(u.removeAttribute("href"),u.onclick=()=>{window.invokeNative("openUrl","https://leafletjs.com/")})},500)},[]),e("div",{className:"mapscomponent-wrapper",children:l(it,{className:"map",crs:A==="losSantos"?rt:lt,style:{backgroundColor:Pe.backgrounds[r]},center:[t[0],t[1]],zoom:4,scrollWheelZoom:!1,zoomControl:!1,doubleClickZoom:!1,dragging:!1,bounceAtZoomLimits:!0,boxZoom:!1,maxBoundsViscosity:.95,maxBounds:p,preferCanvas:!0,children:[e(ot,{url:ct[A].tileServer.replace("{layer}",r),minZoom:N.minZoom,maxZoom:N.maxZoom,maxNativeZoom:N.maxZoom,noWrap:!0},`${A}-${r}`),e(dt,{position:t,icon:mt()})]})})}const O=ce([]);function At(){const{User:t,View:r,UnreadMessages:A}=m.useContext(ae),P=G(X.Settings),N=G(B),p=G(X.PhoneNumber),u=G(z),[a,b]=t,[S,y]=r,[s,o]=A,E=G(O),f=G(D.Emoji),c=G(D.Gif),[$,V]=m.useState(!1),[R,F]=m.useState(null),[x,j]=m.useState(!1),[k,Z]=m.useState(!1),[Q,v]=m.useState(0),[C,L]=m.useState(null),g=m.useRef(null),M=m.useRef(0),T=m.useRef(!1),[h,I]=m.useState({content:"",attachments:[]});if(!a)return null;m.useEffect(()=>{var n;Re("Messages")&&U("Messages",{action:"getMessages",page:0,id:a==null?void 0:a.id},((n=Ge.Messagelist.find(d=>d.id===a.id))==null?void 0:n.messages)??[]).then(d=>{d&&d.length>0&&O.set([...d.reverse()])})},[u==null?void 0:u.active]);const le=()=>{if(h.content.length<=0&&h.attachments.length<=0&&!C)return w("info","Message is empty, returning");let n={sender:p,timestamp:Date.now(),id:a.id,content:h.content,attachments:h.attachments};if(!ht(h.content))return w("error","Message contains invalid characters, returning",h.content);if(C){if(T.current)return;T.current=!0,Ee("Image",C.waves.message).then(d=>{Ee("Audio",C.blob).then(_=>{n.content=`<!AUDIO-MESSAGE-IMAGE="${d}"-AUDIO="${_}"-DURATION="${C.duration}"!>`,U("Messages",{action:"sendMessage",number:a.number,content:n.content,id:a.id},{messageId:Math.random().toString(36).substring(7)}).then(W=>{W&&!P.airplaneMode?O.set([...O.value,{...n,id:W.messageId}]):O.set([...O.value,{...n,delivered:!1}]),T.current=!1,L(null)})}).catch(_=>{console.error("Failed to upload voice message audio",_),T.current=!1})}).catch(d=>{console.error("Failed to upload voice message image",d),T.current=!1});return}if(P.airplaneMode)return O.set([...O.value,{...n,delivered:!1}]);U("Messages",{action:"sendMessage",number:a.number,content:h.content,attachments:h.attachments,id:a.id},{messageId:Math.random().toString(36).substring(7)}).then(d=>{d?(O.set([...O.value,{...n,id:d.messageId}]),L(null)):O.set([...O.value,{...n,delivered:!1}]),I({content:"",attachments:[]}),g.current&&(g.current.value=""),w("info","Updating recent message cache state"),Y.APPS.MESSAGES.messages.set(Y.APPS.MESSAGES.messages.value.map(_=>_.id===a.id?{..._,timestamp:new Date().getTime(),lastMessage:n.content.length>0&&n.content,unread:!1,deleted:!1}:_))})},ue=()=>{D.PopUp.set({title:i("APPS.MESSAGES.SEND_LOCATION_POPUP.TITLE"),description:i("APPS.MESSAGES.SEND_LOCATION_POPUP.TEXT"),buttons:[{title:i("APPS.MESSAGES.SEND_LOCATION_POPUP.CANCEL")},{title:i("APPS.MESSAGES.SEND_LOCATION_POPUP.SEND"),cb:()=>{U("Maps",{action:"getCurrentLocation"},{x:0,y:0}).then(n=>{if(!n)return;let d={id:a.id,sender:p,content:`<!SENT-LOCATION-X=${fe(n.x,2)}Y=${fe(n.y,2)}!>`,attachments:[],timestamp:Date.now()};U("Messages",{action:"sendMessage",number:a.number,content:d.content,attachments:d.attachments,id:d.id},{messageId:Math.random().toString(36).substring(7)}).then(_=>{if(!_)return O.set([...O.value,{...d,delivered:!1}]);O.set([...O.value,{...d,id:_.messageId}])})})}}]})},{handleScroll:ye}=Le({fetchData:n=>U("Messages",{action:"getMessages",id:a.id,page:n}),onDataFetched:n=>{let d=document.querySelector(".message-container");M.current=d.scrollHeight,O.set([...n.reverse(),...O.value])},isReversed:!0,perPage:25});m.useEffect(()=>{let n=document.querySelector(".message-container");const d=n.scrollHeight;n.scrollTop+=d-M.current,n.scroll},[E]),ne("messages:newMessage",n=>{if(a.id===n.channelId){if(P.airplaneMode)return w("warning","Cannot receive message, airplane mode enabled");O.set([...O.value,{...n,timestamp:Date.now()}])}}),ne("messages:renameGroup",n=>{a.id===n.channelId&&(P.airplaneMode||b(d=>({...d,name:n.name})))}),ne("messages:messageDeleted",n=>{if(w("info","messages:messageDeleted triggered",n),!n)return w("error","Did not get any data from messages:messageDeleted, returning");if(P.airplaneMode)return w("warning","Cannot update message state, airplane mode enabled");O.set(O.value.filter(d=>d.id!==n.messageId))}),ne("messages:removeMember",n=>{a.id===n.channelId&&(P.airplaneMode||n.number===p&&(y("userlist"),b(null)))});const De=Ne(n=>{if(!N.DeleteMessages)return w("error","Config.DeleteMessages is set to false");let d=n.target;for(;!d.classList.contains("message");)d=d.parentElement;let _=d.getAttribute("data-id");if(!_)return w("error","Failed to get message id when longpressing");isNaN(_)||(_=parseInt(_));let W=E.find(oe=>oe.id===_);if(!W)return w("error","Failed to find message with id",_);W.sender===p&&(we(W.content)||ke(W.content)||Ie(W.content)||D.ContextMenu.set({buttons:[{title:i("APPS.MESSAGES.DELETE"),color:"red",cb:()=>{U("Messages",{action:"deleteMessage",channel:a.id,id:_}).then(oe=>{if(!oe)return w("error","Failed to delete message")})}}]}))}),ke=n=>!n||!N.EnableMessagePay?!1:/<!SENT-PAYMENT-(\d*)!>/.test(n)?!0:!!/<!REQUESTED-PAYMENT-(\d*)!>/.test(n);return e(te,{children:l(q.div,{...pe("right","message",.2),className:"animation-container",children:[l(ie,{children:[$&&e(pt,{setShow:V,setShowUserInfo:F,sendLocation:ue,setData:b,data:a}),R&&e(Nt,{setShow:F,user:a!=null&&a.isGroup?R:a})]}),l("div",{className:"message-header",children:[l("div",{className:"back",onClick:()=>{var n;y("userlist"),b(null),(n=z.value.active)!=null&&n.data&&z.patch({active:{name:"Messages",data:null}}),a.unread&&(U("Messages",{action:"markRead",id:a.id}),o(d=>d-1))},children:[e(_e,{}),s>0&&e("span",{className:"back-title",children:s})]}),l("div",{className:"user",onClick:()=>{a!=null&&a.isGroup?V(!0):F(!0)},children:[a!=null&&a.isGroup?e("div",{className:"group-avatar",style:{backgroundImage:a!=null&&a.avatar?`url(${a.avatar})`:null},children:!(a!=null&&a.avatar)&&l(te,{children:[a.members.sort((n,d)=>n.name&&d.name?n.name.localeCompare(d.name):n.name?-1:d.name?1:0).sort((n,d)=>(n.avatar?1:-1)-(d.avatar?1:-1)).slice(0,5).map((n,d)=>e("div",{className:"avatar","data-hasavatar":(n==null?void 0:n.avatar)!==void 0,style:{backgroundImage:n!=null&&n.avatar?`url(${n.avatar})`:null,zIndex:a.members.length-d},children:n.name?!(n!=null&&n.avatar)&&se(n.name):e("img",{src:`./assets/img/avatar-placeholder-${P.display.theme}.svg`,alt:""})},d)),a.members.length===0&&e("img",{src:`./assets/img/avatar-placeholder-${P.display.theme}.svg`,alt:""})]})}):e("div",{className:"avatar","data-hasavatar":(a==null?void 0:a.avatar)!==void 0,style:{backgroundImage:a!=null&&a.avatar?`url(${a.avatar})`:null},children:a.name?!(a!=null&&a.avatar)&&se(a.name):e("img",{src:`./assets/img/avatar-placeholder-${P.display.theme}.svg`,alt:""})}),e("div",{className:"name",children:a!=null&&a.isGroup?a.name??`${a.members.length===0?1:a.members.length} ${i("APPS.MESSAGES.PEOPLE")}`:a.name??H(a.number)})]}),l("div",{className:"buttons","data-hidden":a==null?void 0:a.isGroup,children:[e($e,{onClick:()=>{a!=null&&a.isGroup||Se({number:a.number})}}),e(Ve,{onClick:()=>{a!=null&&a.isGroup||Se({number:a.number,videoCall:!0})}})]})]}),e("div",{className:"message-container",onScroll:ye,style:k||x?{height:"48%"}:{},children:e("div",{className:"message-body",children:E.map((n,d)=>e(Pt,{index:d,messages:E,message:n,longPressEvent:De},d))})}),e("div",{className:"attachments",children:h.attachments.map((n,d)=>l("div",{className:"attachment",children:[Ce(n)?e("video",{src:n,muted:!0,controls:!1,loop:!0,autoPlay:!0}):e("img",{src:n}),e(he,{onClick:()=>{I({...h,attachments:h.attachments.filter((_,W)=>W!==d)})}})]},d))}),l("div",{className:"message-bottom","data-expanded":!!(k||x),children:[e("div",{className:"upper",children:l("div",{className:"input","data-border":!C,children:[C?l("div",{className:"audio-message",children:[e(he,{onClick:()=>L(null)}),e("div",{className:"audio-waves",children:e("img",{src:C.waves.placeholder})})]}):e(re,{placeholder:i("APPS.MESSAGES.PLACEHOLDER"),ref:g,value:h.content,onChange:n=>{I({content:n.target.value,attachments:h.attachments})},onKeyDown:n=>{n.key=="Enter"&&le()}}),(h.content.length>0||h.attachments.length>0||C)&&e("div",{className:"send",onClick:le,children:e(be,{})})]})}),!k&&!x&&e("div",{className:"actions-wrapper",children:l("div",{className:"actions",children:[e("div",{className:"action",onClick:()=>{if(f)return D.Emoji.reset();D.Emoji.set({onSelect:n=>I(d=>({content:`${d.content}${n.emoji}`,attachments:d.attachments}))})},children:"😀"}),e("div",{className:"action",onClick:()=>{var n,d,_;h.attachments.length<3&&D.Gallery.set({includeVideos:!0,allowExternal:(_=(d=(n=B)==null?void 0:n.value)==null?void 0:d.AllowExternal)==null?void 0:_.Messages,onSelect:W=>I({...h,attachments:[...h.attachments,W.src]})})},children:e("img",{src:"./assets/img/icons/messages/gallery.png"})}),N.EnableGIFs!==!1&&e("div",{className:"action small",onClick:()=>{if(c)return D.Gif.reset();D.Gif.set({onSelect:n=>I(d=>({content:d.content,attachments:[...d.attachments??[],n]}))})},children:"GIF"}),(N==null?void 0:N.EnableMessagePay)&&!(a!=null&&a.isGroup)&&e("div",{className:"action ",onClick:()=>{j(!1),Z(n=>!n)},children:"$"}),e("div",{className:"action",onClick:()=>ue(),children:e(xe,{})}),(N==null?void 0:N.EnableVoiceMessages)&&e("div",{className:"action",onClick:()=>{Z(!1),j(n=>!n)},children:e(Me,{})})]})}),e(ie,{children:k&&e(ft,{paymentAmount:Q,setPaymentAmount:v,close:()=>Z(!1)})}),e(ie,{children:x&&e(Et,{onEnd:n=>{if(!n)return w("error","Failed to get audio message data");L({blob:n.blob,waves:n.waveform,duration:n.duration}),j(!1)},close:()=>j(!1)})})]})]})})}const Pt=({messages:t,message:r,index:A,longPressEvent:P})=>{var $,V;const{User:N}=m.useContext(ae),p=G(X.PhoneNumber),[u]=N,a=G(B);let b,S,y,s,o,E,f=r.sender===p?"self":"other",c=(($=t[A+1])==null?void 0:$.sender)===p?"self":"other";if(t[A+1]?y=Math.abs(r.timestamp-t[A+1].timestamp)/36e5:c=void 0,u!=null&&u.isGroup)b=(V=u.members.find(R=>R.number===r.sender))==null?void 0:V.name,S=!t[A-1]||t[A-1].sender!==r.sender;else if(b=u.name,r.content)if(Ie(r.content))if(f==="other")r.content=i("APPS.MESSAGES.MISSED_CALL").format({number:r.sender});else return null;else/<!SENT-PAYMENT-(\d*)!>/.test(r.content)?s={amount:r.content.match(/\d/g).join(""),request:!1}:/<!REQUESTED-PAYMENT-(\d*)!>/.test(r.content)&&(s={amount:r.content.match(/\d/g).join(""),request:!0});if(we(r.content)){let R=r.content.match(/X=(-?\d*\.?\d*)Y/)[1],F=r.content.match(/Y=(-?\d*\.?\d*)!>/)[1];o={x:R,y:F}}return St(r.content)&&(E={wave:r.content.match(/AUDIO-MESSAGE-IMAGE="([^"]+)"/)[1],src:r.content.match(/AUDIO="([^"]+)"/)[1],duration:r.content.match(/DURATION="([^"]+)"/)[1]}),l("div",{className:`message ${f}`,"data-id":r.id,...P,children:[S&&f=="other"&&e("div",{className:"user",children:b??H(r.sender)}),r.delivered===!1?l("div",{className:"content-wrapper",children:[s&&e("div",{className:"payment",children:a.CurrencyFormat.replace("%s",s.amount)}),!s&&e("div",{className:"content",children:ge(r.content)}),e(Fe,{})]}):s||o||E?l(te,{children:[o&&l("div",{className:"location",onClick:()=>{D.ContextMenu.set({buttons:[{title:i("APPS.MESSAGES.OPEN_IN_MAPS"),cb:()=>{z.patch({active:{name:"Maps",data:{location:[o.y,o.x],name:i("APPS.MESSAGES.USERS_LOCATION").format({name:b??H(r.sender)}),icon:u.avatar}}})}},{title:i("APPS.MAPS.SET_WAYPOINT"),cb:()=>{U("Maps",{action:"setWaypoint",data:{x:o.x,y:o.y}})}}]})},children:[e(vt,{location:[parseFloat(o.y),parseFloat(o.x)]}),f==="other"&&l("div",{className:"sender",children:[b??H(r.sender)," ",i("APPS.MESSAGES.SENT_LOCATION")]})]}),s&&e("div",{className:"payment",children:s.request?l("div",{className:de("request",f),children:[l("div",{className:"title",children:[a.CurrencyFormat.replace("%s",ve(s.amount).toString())," ",i("APPS.MESSAGES.PAY.REQUESTED")]}),f==="other"&&e("div",{className:"button",onClick:()=>Oe(s.amount,{id:u.id,number:u.number,name:u.name}),children:i("APPS.MESSAGES.PAY.PAY")})]}):e("div",{className:"sent",children:a.CurrencyFormat.replace("%s",ve(s.amount).toString())})}),E&&e(Mt,{data:E,sender:f})]}):r.content&&e("div",{className:"content",children:ge(r.content)}),r.attachments&&r.attachments.length>0&&e("div",{className:"attatchments",children:r.attachments.map((R,F)=>Ce(R)?e("video",{src:R,controls:!1,loop:!0,autoPlay:!0,muted:!0,onClick:x=>D.FullscreenImage.set(R)},F):e(Te,{src:R,onClick:()=>D.FullscreenImage.set(R)},F))}),r.delivered===!1?e("div",{className:"status",children:i("APPS.MESSAGES.NOT_DELIVERED")}):t[A+1]&&y>6?e("div",{className:"date",children:Ae(r.timestamp)}):f!==c&&e("div",{className:"date",children:Ae(r.timestamp)})]},A)},Mt=({data:t,sender:r})=>{var b;const[A,P]=m.useState(!1),[N,p]=m.useState(0),u=m.useRef(null);m.useEffect(()=>{u.current&&(u.current.onended=()=>P(!1))},[u]);const a=S=>{S=Math.floor(S);const y=Math.floor(S/60),s=S-y*60;return`${y<10?"0"+y:y}:${s<10?"0"+s:s}`};return l("div",{className:`voice-message ${r}`,children:[e("a",{onClick:()=>{u.current&&(A?(u.current.pause(),u.current.currentTime=0):u.current.play().catch(()=>w("error","Failed to play audio message")),P(S=>!S))},children:A?e(Ye,{}):e(He,{})}),l("div",{className:"wave",children:[e("div",{className:"overlay",style:{width:`${(t.duration-N)/t.duration*100}%`}}),e("img",{src:t.wave,alt:"wave"})]}),e("div",{className:"duration",children:a(A&&Math.floor(((b=u.current)==null?void 0:b.currentTime)+.5)!==0?u.current.currentTime:t.duration)}),e("audio",{ref:u,onTimeUpdate:S=>p(S.currentTarget.currentTime),children:e("source",{src:t.src,type:"audio/mpeg"})})]})},Nt=({user:t,setShow:r})=>{const A=G(X.Settings);return l(q.div,{...me,className:"info-panel",children:[e("div",{className:"info-panel-header",children:e("div",{className:"done",onClick:()=>r(!1),children:i("APPS.MESSAGES.DONE")})}),l("div",{className:"info-panel-body",children:[l("div",{className:"info-panel-top",children:[e("div",{className:"avatar","data-hasavatar":(t==null?void 0:t.avatar)!==void 0,style:{backgroundImage:t!=null&&t.avatar?`url(${t.avatar})`:null},children:t.name?!(t!=null&&t.avatar)&&se(t.name):e("img",{src:`./assets/img/avatar-placeholder-${A.display.theme}.svg`,alt:""})}),e("div",{className:"name",children:t.name??H(t.number)})]}),e("div",{className:"items",children:!t.company&&l(te,{children:[t.name&&e("div",{className:"info-section",children:e("div",{className:"item blue",onClick:()=>je(t.number),children:H(t.number)})}),e("div",{className:"info-section",children:t.name?e("div",{className:"item blue",onClick:()=>{D.Share.set({type:"contact",data:{firstname:t.firstname,lastname:t.lastname,number:t.number,avatar:t.avatar}})},children:i("APPS.PHONE.CONTACTS.SHARE_CONTACT")}):e("div",{className:"item blue",onClick:()=>{z.patch({active:{name:"Phone",data:{view:"newContact",number:t.number}}})},children:i("APPS.PHONE.CONTACTS.ADD_CONTACT")})})]})})]})]})},pt=t=>{const{View:r}=m.useContext(ae),A=G(X.Settings),[P,N]=r,[p,u]=m.useState(t.data.name),[a,b]=m.useState(t.data.avatar);let S=t.data,y=!S.members.find(s=>s.isOwner);return e(te,{children:l(q.div,{...me,className:"info-panel",children:[l("div",{className:"info-panel-header",children:[e("div",{}),e("div",{className:"close",children:e("div",{className:"button",onClick:()=>t.setShow(!1)})}),e("div",{className:"done",onClick:()=>{p&&p!==""&&p!==S.name?U("Messages",{action:"renameGroup",id:S.id,name:p}).then(s=>{t.setShow(!1)}):t.setShow(!1)},children:i("APPS.MESSAGES.DONE")})]}),l("div",{className:"info-panel-body",children:[l("div",{className:"info-panel-top",children:[a?e(Te,{className:"group-image",src:a,ignoreStreamerMode:!0}):l("div",{className:"group-avatar",children:[S.members.sort((s,o)=>s.avatar?1:-1).slice(0,5).map((s,o)=>e("div",{className:"avatar","data-hasavatar":(s==null?void 0:s.avatar)!==void 0,style:{backgroundImage:s!=null&&s.avatar?`url(${s.avatar})`:null,zIndex:S.members.length-o},children:s.name?!(s!=null&&s.avatar)&&se(s.name):e("img",{src:`./assets/img/avatar-placeholder-${A.display.theme}.svg`,alt:""})},o)),S.members.length===0&&e("img",{src:`./assets/img/avatar-placeholder-${A.display.theme}.svg`,alt:""})]}),e("div",{className:"add-photo",onClick:()=>{var s,o,E;a?D.PopUp.set({title:i("APPS.MESSAGES.REMOVE_AVATAR_POPUP.TITLE"),description:i("APPS.MESSAGES.REMOVE_AVATAR_POPUP.DESCRIPTION"),buttons:[{title:i("APPS.MESSAGES.REMOVE_AVATAR_POPUP.CANCEL")},{title:i("APPS.MESSAGES.REMOVE_AVATAR_POPUP.REMOVE"),color:"red",cb:()=>{U("Messages",{action:"removeGroupAvatar",id:S.id},!0).then(f=>{if(!f)return w("warning","Could not remove group avatar");t.setData(c=>{let $=c;return $.avatar=null,$}),b(null)})}}]}):D.Gallery.set({allowExternal:(E=(o=(s=B)==null?void 0:s.value)==null?void 0:o.AllowExternal)==null?void 0:E.Messages,onSelect:f=>U("Messages",{action:"setGroupAvatar",id:S.id,avatar:f.src},!0).then(c=>{if(!c)return w("warning","Could not set group avatar");t.setData($=>{let V=$;return V.avatar=f.src,V}),b(f.src)})})},children:a?"Remove Photo":" Add Photo"})]}),l("div",{className:"items",children:[e("div",{className:"info-section",children:l("div",{className:"item blue",children:[e(We,{className:"add"}),e(re,{defaultValue:S.name??i("APPS.MESSAGES.GROUP_NAME"),onChange:s=>u(s.target.value)})]})}),l("div",{className:"subtitle",children:[S.members.length===0?1:S.members.length," ",i("APPS.MESSAGES.MEMBERS")]}),l("div",{className:"info-section",children:[l("div",{className:"item",onClick:()=>D.ContactSelector.set({filter:S.members.map(s=>s.number),onSelect:s=>{if(S.members.find(o=>o.number===s.number))return w("info","User is already in group");U("Messages",{action:"addMember",id:S.id,number:s.number},!0).then(o=>{if(!o)return w("warning","Could not add member to group");t.setData(E=>{let f=E;return f.members.push({...s,name:K(s.firstname,s.lastname),isOwner:!1}),f})})}}),children:[e(Be,{className:"add"}),e("div",{className:"name",children:i("APPS.MESSAGES.ADD_MEMBER")})]}),S.members.sort((s,o)=>s.name&&!o.name?-1:!s.name&&o.name?1:s.name<o.name?-1:s.name>o.name?1:0).map((s,o)=>l("div",{className:"item",children:[y&&e(Xe,{className:"remove",onClick:()=>{D.PopUp.set({title:i("APPS.MESSAGES.REMOVE_POPUP.TITLE"),description:i("APPS.MESSAGES.REMOVE_POPUP.TEXT").format({name:s.name??H(s.number)}),buttons:[{title:i("APPS.MESSAGES.CANCEL")},{title:i("APPS.MESSAGES.REMOVE_POPUP.REMOVE"),color:"red",cb:()=>{U("Messages",{action:"removeMember",number:s.number,id:S.id}).then(E=>{E&&(t.setData(f=>{let c=f;return c.members=c.members.filter($=>$.number!==s.number),c}),t.setShow(!1))})}}]})}}),e("div",{className:"avatar","data-hasavatar":(s==null?void 0:s.avatar)!==void 0,style:{backgroundImage:s!=null&&s.avatar?`url(${s.avatar})`:null},children:s.name?!(s!=null&&s.avatar)&&se(s.name):e("img",{src:`./assets/img/avatar-placeholder-${A.display.theme}.svg`,alt:""})}),l("div",{className:"details",children:[e("div",{className:"name",children:s.name??H(s.number)}),s.name&&e("div",{className:"phone-number",children:H(s.number)})]}),e(Ze,{className:"info",onClick:()=>t.setShowUserInfo({...s})})]},o))]}),e("div",{className:"info-section",children:e("div",{className:"item blue",onClick:()=>t.sendLocation(),children:i("APPS.MESSAGES.SHARE_LOCATION")})}),e("div",{className:"info-section",onClick:()=>{D.PopUp.set({title:i("APPS.MESSAGES.LEAVE_POPUP.TITLE"),description:i("APPS.MESSAGES.LEAVE_POPUP.TEXT"),buttons:[{title:i("APPS.MESSAGES.CANCEL")},{title:i("APPS.MESSAGES.LEAVE_POPUP.LEAVE"),color:"red",cb:()=>{U("Messages",{action:"leaveGroup",id:S.id}).then(s=>{if(!s)return w("info","Failed to leave group, server didnt callback request");N("userlist"),t.setShow(!1)})}}]})},children:l("div",{className:"item red",children:[e(qe,{}),i("APPS.MESSAGES.LEAVE_GROUP")]})})]})]})]})})};function Ct(){const{User:t,View:r,Newmessage:A,ImportedUser:P}=m.useContext(ae),[N,p]=t,[u,a]=r,[b,S]=P,y=G(X.Settings),s=G(X.PhoneNumber),[o,E]=A,f=G(Y.APPS.PHONE.contacts),[c,$]=m.useState([]),V=m.useRef(null),[R,F]=m.useState(""),[x,j]=m.useState([]),[k,Z]=m.useState({content:"",attachments:[]});m.useEffect(()=>{b&&($([b]),S(null))},[b]);const Q=()=>{(k.content.length>0||k.attachments.length>0)&&(c.length>1?U("Messages",{action:"createGroup",members:c,content:k.content,attachments:k.attachments}).then(v=>{if(!v)return w("error","Failed to create group");p({id:v.channelId,lastMessage:k.content,timestamp:Date.now(),isGroup:!0,members:c.map(C=>{let L=K(C.firstname,C.lastname);return{...C,name:L}})}),a("messages"),E(!1)}):(U("Messages",{action:"sendMessage",number:c[0].number,content:k.content,attachments:k.attachments}).then(v=>{var g,M,T,h;if(!v)return w("error","Failed to send message");let C;c[0].name?C=c[0].name:(g=c[0])!=null&&g.firstname&&(C=K((M=c[0])==null?void 0:M.firstname,(T=c[0])==null?void 0:T.lastname));let L={number:c[0].number,name:C,avatar:(h=c[0])==null?void 0:h.avatar};p({...L,id:v.channelId,lastMessage:k.content,timestamp:Date.now()}),w("info","Updating recent message cache state"),Y.APPS.MESSAGES.messages.set(Y.APPS.MESSAGES.messages.value.map(I=>I.id===v.channelId?{...I,timestamp:new Date().getTime(),lastMessage:k.content,unread:!1,deleted:!1}:I))}),a("messages"),E(!1)))};return m.useEffect(()=>{if(R.length>0){if(!f)return w("error","Contacts not loaded");j(f.filter(v=>{let C=K(v.firstname,v.lastname);return C&&C.toLowerCase().includes(R.toLowerCase())&&!v.company}))}else j([])},[R]),l(q.div,{...me,className:"new-message-container",children:[l("div",{className:"new-message-header",children:[e("span",{}),e("div",{className:"title",children:i("APPS.MESSAGES.NEW_MESSAGE")}),e("div",{className:"button",onClick:()=>{var C,L,g;c.length>0&&(k.content.length>0||k.attachments.length>0)?Q():(E(!1),(g=(L=(C=z)==null?void 0:C.value)==null?void 0:L.active)!=null&&g.data&&z.patch({active:{...z.value.active,data:null}}))},children:c.length>0&&(k.content.length>0||k.attachments.length>0)?i("APPS.MESSAGES.SEND"):i("APPS.MESSAGES.CANCEL")})]}),l("div",{className:"new-message-body",children:[l("div",{className:"new-message-search",children:[l("div",{className:"to",children:[i("APPS.MESSAGES.TO"),":"]}),e("div",{className:"contacts",children:c.map((v,C)=>{let L=K(v.firstname,v.lastname),g=L!=="Unknown";return e("div",{className:de("contact",g?"green":"blue"),onClick:()=>{D.PopUp.set({title:i("APPS.MESSAGES.REMOVE_POPUP.TITLE"),description:i("APPS.MESSAGES.REMOVE_POPUP.TEXT").format({NAME:L??H(v.number)}),buttons:[{title:i("APPS.MESSAGES.CANCEL")},{title:i("APPS.MESSAGES.REMOVE_POPUP.REMOVE"),color:"red",cb:()=>{let M=c.filter(T=>T.number!==v.number);$(M)}}]})},children:g?L:H(v.number)},C)})}),e(re,{type:"text",ref:V,onChange:v=>{if(F(v.target.value),v.target.value.length==s.length&&/^\d+$/g.test(v.target.value)){if(v.target.value===s||c.find(L=>L.number==v.target.value))return;$([...c,{number:v.target.value}]),V.current.value="",F("")}},onKeyDown:v=>{var C;v.key=="Backspace"&&R.length==0?((C=c[c.length-1])==null?void 0:C.name)===void 0?(V.current.value=c[c.length-1].number,$(c.slice(0,c.length-1))):$(c.slice(0,-1)):v.key=="Tab"&&(v.preventDefault(),x.length==1&&($([...c,x[0]]),V.current.value="",F("")))}})]}),e("div",{className:"search-results",children:x&&x.filter(v=>!c.find(C=>C.number==v.number)).map((v,C)=>{let L=K(v.firstname,v.lastname);return l("div",{className:"contact",onClick:()=>{c.find(M=>M.number==v.number)||($([...c,v]),V.current.value="",F(""))},children:[e("img",{src:v.avatar??`./assets/img/avatar-placeholder-${y.display.theme}.svg`}),l("div",{className:"user",children:[e("div",{className:"name",children:L}),e("div",{className:"number",children:H(v.number)})]})]},C)})})]}),c.length>0&&x.length===0&&e("div",{className:"message-bottom absolute",children:e("div",{className:"upper",children:l("div",{className:"input",children:[e(re,{placeholder:i("APPS.MESSAGES.PLACEHOLDER"),value:k.content,onChange:v=>{Z({content:v.target.value??"",attachments:k.attachments})},onKeyDown:v=>{v.key=="Enter"&&Q()}}),(k.content.length>0||k.attachments.length>0)&&e("div",{className:"send",onClick:()=>Q(),children:e(be,{})})]})})})]})}const J=ce([]),ee=ce([]);function bt(){var L;const{User:t,View:r,Newmessage:A,UnreadMessages:P,ImportedUser:N}=m.useContext(ae),p=G(X.PhoneNumber),u=G(X.Settings),a=(L=G(z))==null?void 0:L.active,[b,S]=t,[y,s]=r,[o,E]=N,[f,c]=A,[$,V]=P,R=G(Y.APPS.PHONE.contacts),F=G(Y.APPS.MESSAGES.messages),x=G(J),[j,k]=m.useState(""),[Z,Q]=m.useState(!1),v=G(ee);m.useEffect(()=>{F?(w("info","Using cache for recent messages"),V(x.filter(g=>g.unread).length),J.set(F.map(g=>{if(!g.name){let M=R.find(T=>T.number===g.number);if(!M)return g;g.name=K(M.firstname,M.lastname),g.avatar=M==null?void 0:M.avatar}return g}))):U("Messages",{action:"getRecentMessages"},Ge.Messagelist).then(g=>{let M=g.map(T=>{if(T.isGroup)return T.members=T.members.filter(h=>h.number!==p).map(h=>{let I=R.find(le=>le.number===h.number);return{name:I&&I.firstname?K(I==null?void 0:I.firstname,I==null?void 0:I.lastname):void 0,avatar:I==null?void 0:I.avatar,blocked:I==null?void 0:I.blocked,favourite:I==null?void 0:I.favourite,number:h.number,isOwner:h.isOwner}}),T;{let h=R.find(I=>I.number===T.number);return T.name=h!=null&&h.lastname?`${h.firstname} ${h.lastname}`:h==null?void 0:h.firstname,T.avatar=h==null?void 0:h.avatar,T}});V(M.filter(T=>T.unread).length),J.set(M),w("info","setting cache"),Y.APPS.MESSAGES.messages.set(M)})},[F]);let C=m.useRef(!1);return m.useEffect(()=>{var g;if(!C.current&&a!=null&&a.data&&(C.current=!0,a!=null&&a.data&&((g=a.data)==null?void 0:g.view)=="messages")){let M=x.find(T=>T.number===a.data.number);M?(S(M),s("messages")):(c(!0),E({number:a.data.number,name:a.data.name,avatar:a.data.avatar}))}},[a==null?void 0:a.data,x]),ne("messages:newMessage",g=>{let M=JSON.parse(JSON.stringify(x)),T=M.findIndex(h=>h.id===g.channelId);u.airplaneMode||(T!==-1&&M.unshift(M.splice(T,1)[0]),M[0].lastMessage=g.content,M[0].timestamp=new Date,J.set(M))}),l(te,{children:[e(ie,{children:f&&e(Ct,{})}),l(q.div,{...pe("left","messagelist",.2),className:"animation-container",children:[l("div",{className:"messages-header",children:[l("div",{className:"buttons",children:[e("div",{className:"edit",onClick:()=>Q(!Z),children:Z?i("APPS.MESSAGES.DONE"):i("APPS.MESSAGES.EDIT")}),e(ze,{"data-disabled":Z,onClick:()=>c(!0)})]}),e("div",{className:"title",children:i("APPS.MESSAGES.TITLE")})]}),e(Qe,{placeholder:i("SEARCH"),onChange:g=>k(g.target.value)}),e("div",{className:"users-list",children:x.filter(g=>{var M;return g.deleted?!1:(g.isGroup?g.members.find(T=>{var h;return((h=T.name)==null?void 0:h.toLowerCase().includes(j.toLowerCase()))||T.number.includes(j)}):((M=g.name)==null?void 0:M.toLowerCase().includes(j.toLowerCase()))||g.number.includes(j))||g.lastMessage.toLowerCase().includes(j.toLowerCase())}).sort((g,M)=>M.timestamp-g.timestamp).map((g,M)=>e(Tt,{user:g,editMode:Z,onClick:()=>{if(S(g),s("messages"),g.unread){U("Messages",{action:"markRead",id:g.id},!0),V(h=>h-1);let T=Y.APPS.MESSAGES.messages.value;Y.APPS.MESSAGES.messages.set(T.map(h=>(h.id===g.id&&(h.unread=!1),h)))}}},M))}),e(ie,{children:Z&&l(q.div,{initial:{opacity:0,y:50},animate:{opacity:1,y:0},exit:{opacity:0,y:50},transition:{duration:.2,ease:"easeInOut"},className:"messages-footer",children:[e("div",{className:"button","data-disabled":!0,children:i("APPS.MESSAGES.READ")}),e("div",{className:"button",onClick:()=>{if(v.length===0)return w("info","No messages selected, can't delete");D.PopUp.set({title:i("APPS.MESSAGES.DELETE_CONVERSATION.TITLE"),description:i("APPS.MESSAGES.DELETE_CONVERSATION.DESCRIPTION"),buttons:[{title:i("APPS.MESSAGES.CANCEL")},{title:i("APPS.MESSAGES.DELETE"),cb:()=>{U("Messages",{action:"deleteConversations",channels:v},!0).then(g=>{if(!g)return w("error","Failed to delete conversations");Q(!1),J.set(x.filter(M=>!v.includes(M.id))),Y.APPS.MESSAGES.messages.set([...Y.APPS.MESSAGES.messages.value.map(M=>(v.includes(M.id)&&(M.deleted=!0),M))]),ee.set([])})}}]})},children:i("APPS.MESSAGES.DELETE")})]})})]})]})}const Tt=({user:t,editMode:r,onClick:A})=>{var y,s;const P=G(B),N=G(X.Settings),p=G(J),[u,a]=m.useState(!1);let b;const S=Ne(o=>{D.ContextMenu.set({buttons:[{title:i("APPS.MESSAGES.MARK_AS_READ"),cb:()=>{U("Messages",{action:"markRead",id:t.id},!0).then(E=>{if(!E)return w("error","Failed to mark message as read");J.set(p.map(c=>(c.id===t.id&&(c.unread=!1),c)));let f=Y.APPS.MESSAGES.messages.value;Y.APPS.MESSAGES.messages.set(f.map(c=>(c.id===t.id&&(c.unread=!1),c)))})}},{title:i("APPS.MESSAGES.DELETE_CONVERSATION.TITLE"),color:"red",cb:()=>{D.PopUp.set({title:i("APPS.MESSAGES.DELETE_CONVERSATION.TITLE"),description:i("APPS.MESSAGES.DELETE_CONVERSATION.DESCRIPTION"),buttons:[{title:i("APPS.MESSAGES.CANCEL")},{title:i("APPS.MESSAGES.DELETE"),cb:()=>{U("Messages",{action:"deleteConversations",channels:[t.id]},!0).then(E=>{if(!E)return w("error","Failed to delete conversations");J.set(p.filter(f=>f.id!==t.id)),Y.APPS.MESSAGES.messages.set([...Y.APPS.MESSAGES.messages.value.map(f=>(f.id===t.id&&(f.deleted=!0),f))]),ee.set([])})}}]})}}]})});if(t.isGroup)if(t.name)b=t.name;else if(t.members.length===0)b=i("APPS.MESSAGES.GROUP");else{let o=t.members.length-1;b=t.members.sort((E,f)=>E.name&&!f.name?-1:!E.name&&f.name?1:E.name<f.name?-1:E.name>f.name?1:0).slice(0,2).map((E,f)=>{let c=E.name?E.name:H(E.number);return f===1&&o>2?`${c} +${o} ${i("APPS.MESSAGES.OTHER").toLowerCase()}`:c}).join(", ")}else b=t.name;if(t.lastMessage){if(t.lastMessage==="Attachment"&&(t.lastMessage=i("APPS.MESSAGES.SENT_A_PHOTO")),/<!SENT-PAYMENT-(\d*)!>/.test(t.lastMessage)){let o=t.lastMessage.match(/\d/g).join("");t.lastMessage=`${i("APPS.MESSAGES.SENT")} ${P.CurrencyFormat.replace("%s",o)}`}else if(/<!REQUESTED-PAYMENT-(\d*)!>/.test(t.lastMessage)){let o=t.lastMessage.match(/\d/g).join("");t.lastMessage=`${i("APPS.MESSAGES.REQUESTED")} $${o}`}else if(/<!SENT-LOCATION-X=(-?\d*\.?\d*)Y=(-?\d*\.?\d*)!>/.test(t.lastMessage))t.lastMessage=`${i("APPS.MESSAGES.SENT_LOCATION_SHORT")}`;else if(t.lastMessage.startsWith('<!AUDIO-MESSAGE-IMAGE="'))t.lastMessage=i("APPS.MESSAGES.SENT_AUDIO_MESSAGE");else if(t.lastMessage==="<!CALL-NO-ANSWER!>")t.lastMessage=i("APPS.MESSAGES.TRIED_TO_CALL").format({number:H(t.number)});else if(t.lastMessage==="")return}return m.useEffect(()=>{u?ee.set([...ee.value,t.id]):ee.set(ee.value.filter(o=>o!==t.id))},[u]),l(q.div,{initial:{opacity:0,scale:.9},whileInView:{opacity:1,scale:1},viewport:{once:!0},className:"user",...S,onClick:()=>{r?a(!u):A()},children:[l("div",{className:"items",children:[r&&e(q.div,{initial:{opacity:0,scale:.9},animate:{opacity:1,scale:1},exit:{opacity:0,scale:.9},className:"check","data-checked":u,onClick:o=>{o.stopPropagation(),a(!u)},children:u&&e(Ke,{})},"check"),e("div",{className:de("dot",t.unread&&"unread")})]}),t.isGroup?l("div",{className:"avatar group",children:[t.members.map((o,E)=>{if(E<=3)return o.avatar?e("div",{"data-hasavatar":"true",style:{backgroundImage:`url(${o.avatar})`}},E):o.name?e("div",{children:o.name.charAt(0)},E):e("div",{className:"unknown"},E)}),t.members.length===0&&e("img",{className:"avatar",src:`assets/img/avatar-placeholder-${N.display.theme}.svg`})]}):e("div",{className:"avatar",style:{backgroundImage:t!=null&&t.avatar?`url(${t.avatar})`:null},children:t.name?!(t!=null&&t.avatar)&&se(t.name):e("img",{src:`assets/img/avatar-placeholder-${N.display.theme}.svg`,alt:""})}),l("div",{className:"user-body",children:[l("div",{className:"user-header",children:[e("div",{className:"name",children:b??H(t.number)}),l("div",{className:"right",children:[e("div",{className:"time",children:Je(t.timestamp)}),e(et,{})]})]}),e("div",{className:"content",children:((y=t.lastMessage)==null?void 0:y.length)>40?((s=t.lastMessage)==null?void 0:s.substring(0,40))+"...":t.lastMessage})]})]})};const ae=m.createContext(null);function Gt(){const[t,r]=m.useState(null),[A,P]=m.useState("userlist"),[N,p]=m.useState(null),[u,a]=m.useState(0),[b,S]=m.useState(!1);return e("div",{className:"messages-container","data-view":A,children:e(ae.Provider,{value:{User:[t,r],View:[A,P],Newmessage:[b,S],ImportedUser:[N,p],UnreadMessages:[u,a]},children:A==="userlist"?e(bt,{}):t&&e(At,{})})})}export{ae as MessagesContext,Gt as default};
